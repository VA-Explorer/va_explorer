from django.db import models
from simple_history.models import HistoricalRecords
from django.contrib.postgres.fields import JSONField
#from django.contrib.auth import get_user_model
from django.contrib.auth.models import User
from treebeard.mp_tree import MP_Node

class Location(MP_Node):
    # Locations are set up as a tree structure, allowing a regions and sub-regions along with the
    # ability to constrain access control by region; we use django-treabeard's materialized path
    # implementation for efficiency of tree operations
    name = models.TextField()
    location_type = models.TextField()
    node_order_by = ['name']

    # A user can have their access scoped by one or more locations
    #users = models.ManyToManyField(get_user_model(), related_name='locations')

    # Automatically set timestamps
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.name

    def descendant_ids(self):
        return [descendant.id for descendant in self.get_descendants()]

    def parent_id(self):
        return self.get_parent().id

class VerbalAutopsy(models.Model):
    # Each VerbalAutopsy is associated with a facility, which is the leaf node location
    location = models.ForeignKey(Location, related_name='verbalautopsies', on_delete=models.CASCADE)

    # The VA fields collected as part of the WHO VA form or local versions
    # TODO: Need an approach that supports different variants in different countries
    deviceid = models.TextField()
    phonenumber = models.TextField()
    simserial = models.TextField()
    username = models.TextField()
    bid = models.TextField()
    bid2 = models.TextField()
    bid_check = models.TextField()
    bid_image = models.TextField()
    province = models.TextField()
    area = models.TextField()
    hospital = models.TextField()
    Id10002 = models.TextField()
    Id10003 = models.TextField()
    Id10004 = models.TextField()
    Id10007 = models.TextField()
    Id10008 = models.TextField()
    Id10009 = models.TextField()
    Id10010 = models.TextField()
    Id10012 = models.TextField()
    Id10013 = models.TextField()
    Id10011 = models.TextField()
    Id10017 = models.TextField()
    Id10018 = models.TextField()
    Id10019 = models.TextField()
    Id10020 = models.TextField()
    Id10021 = models.TextField()
    Id10022 = models.TextField()
    Id10023_a = models.TextField()
    Id10023_b = models.TextField()
    Id10023 = models.TextField()
    Id10024 = models.TextField()
    ageInDays = models.TextField()
    ageInDays2 = models.TextField()
    ageInYears = models.TextField()
    ageInYearsRemain = models.TextField()
    ageInMonths = models.TextField()
    ageInMonthsRemain = models.TextField()
    isNeonatal1 = models.TextField()
    isChild1 = models.TextField()
    isAdult1 = models.TextField()
    displayAgeNeonate = models.TextField()
    displayAgeChild = models.TextField()
    displayAgeAdult = models.TextField()
    age_group = models.TextField()
    age_neonate_days = models.TextField()
    age_child_unit = models.TextField()
    age_child_days = models.TextField()
    age_child_months = models.TextField()
    age_child_years = models.TextField()
    age_adult = models.TextField()
    ageInMonthsByYear = models.TextField()
    ageInYears2 = models.TextField()
    isNeonatal2 = models.TextField()
    isChild2 = models.TextField()
    isAdult2 = models.TextField()
    isNeonatal = models.TextField()
    isChild = models.TextField()
    isAdult = models.TextField()
    ageInDaysNeonate = models.TextField()
    Id10008_check = models.TextField()
    Id10058 = models.TextField()
    Id10051 = models.TextField()
    Id10052 = models.TextField()
    Id10053 = models.TextField()
    Id10054 = models.TextField()
    Id10055 = models.TextField()
    Id10057 = models.TextField()
    Id10059 = models.TextField()
    Id10060_check = models.TextField()
    Id10060 = models.TextField()
    Id10061 = models.TextField()
    Id10062 = models.TextField()
    Id10063 = models.TextField()
    Id10064 = models.TextField()
    Id10065 = models.TextField()
    Id10066 = models.TextField()
    Id10069 = models.TextField()
    Id10069_a = models.TextField()
    Id10070 = models.TextField()
    Id10071_check = models.TextField()
    Id10071 = models.TextField()
    Id10072 = models.TextField()
    Id10073 = models.TextField()
    Id10476 = models.TextField()
    narrat_image = models.TextField()
    Id10477 = models.TextField()
    Id10478 = models.TextField()
    Id10479 = models.TextField()
    id10477_check = models.TextField()
    id10478_check = models.TextField()
    id10479_check = models.TextField()
    Id10104 = models.TextField()
    Id10105 = models.TextField()
    Id10106 = models.TextField()
    Id10107 = models.TextField()
    Id10108 = models.TextField()
    Id10109 = models.TextField()
    Id10110 = models.TextField()
    Id10111 = models.TextField()
    Id10112 = models.TextField()
    Id10113 = models.TextField()
    Id10114 = models.TextField()
    Id10115 = models.TextField()
    Id10116 = models.TextField()
    Id10077 = models.TextField()
    Id10079 = models.TextField()
    Id10080 = models.TextField()
    Id10081 = models.TextField()
    Id10082 = models.TextField()
    Id10083 = models.TextField()
    Id10084 = models.TextField()
    Id10085 = models.TextField()
    Id10086 = models.TextField()
    Id10087 = models.TextField()
    Id10088 = models.TextField()
    Id10089 = models.TextField()
    Id10090 = models.TextField()
    Id10091 = models.TextField()
    Id10092 = models.TextField()
    Id10093 = models.TextField()
    Id10094 = models.TextField()
    Id10095 = models.TextField()
    Id10096 = models.TextField()
    Id10097 = models.TextField()
    Id10098 = models.TextField()
    Id10099 = models.TextField()
    Id10100 = models.TextField()
    Id10351 = models.TextField()
    Id10408 = models.TextField()
    Id10120_0 = models.TextField()
    id10120_unit = models.TextField()
    Id10121 = models.TextField()
    Id10122 = models.TextField()
    Id10120_1 = models.TextField()
    Id10120 = models.TextField()
    Id10123 = models.TextField()
    Id10125 = models.TextField()
    Id10126 = models.TextField()
    Id10127 = models.TextField()
    Id10128 = models.TextField()
    Id10129 = models.TextField()
    Id10130 = models.TextField()
    Id10131 = models.TextField()
    Id10132 = models.TextField()
    Id10133 = models.TextField()
    Id10134 = models.TextField()
    Id10135 = models.TextField()
    Id10136 = models.TextField()
    Id10137 = models.TextField()
    Id10138 = models.TextField()
    Id10139 = models.TextField()
    Id10140 = models.TextField()
    Id10141 = models.TextField()
    Id10142 = models.TextField()
    Id10143 = models.TextField()
    Id10144 = models.TextField()
    Id10147 = models.TextField()
    Id10148_a = models.TextField()
    Id10148_units = models.TextField()
    Id10148_b = models.TextField()
    Id10148_c = models.TextField()
    Id10148 = models.TextField()
    Id10149 = models.TextField()
    Id10150 = models.TextField()
    Id10151 = models.TextField()
    Id10152 = models.TextField()
    Id10153 = models.TextField()
    Id10154_units = models.TextField()
    Id10154_a = models.TextField()
    Id10154_b = models.TextField()
    Id10154 = models.TextField()
    Id10155 = models.TextField()
    Id10156 = models.TextField()
    Id10157 = models.TextField()
    Id10158 = models.TextField()
    Id10159 = models.TextField()
    Id10161_0 = models.TextField()
    id10161_unit = models.TextField()
    Id10161_1 = models.TextField()
    Id10162 = models.TextField()
    Id10163 = models.TextField()
    Id10161 = models.TextField()
    Id10165 = models.TextField()
    Id10166 = models.TextField()
    Id10167_a = models.TextField()
    Id10167_units = models.TextField()
    Id10167_b = models.TextField()
    Id10167_c = models.TextField()
    Id10167 = models.TextField()
    Id10168 = models.TextField()
    Id10169_a = models.TextField()
    Id10169_units = models.TextField()
    Id10169_b = models.TextField()
    Id10169_c = models.TextField()
    Id10169 = models.TextField()
    Id10170 = models.TextField()
    Id10171 = models.TextField()
    Id10172 = models.TextField()
    Id10173_nc = models.TextField()
    id10173_check = models.TextField()
    Id10173_a = models.TextField()
    Id10173 = models.TextField()
    Id10174 = models.TextField()
    Id10175 = models.TextField()
    Id10176 = models.TextField()
    Id10178_unit = models.TextField()
    Id10178 = models.TextField()
    Id10179 = models.TextField()
    Id10179_1 = models.TextField()
    Id10181 = models.TextField()
    Id10182_units = models.TextField()
    Id10182_a = models.TextField()
    Id10182_b = models.TextField()
    Id10182 = models.TextField()
    Id10183 = models.TextField()
    Id10184_a = models.TextField()
    Id10184_units = models.TextField()
    Id10184_b = models.TextField()
    Id10184_c = models.TextField()
    Id10185 = models.TextField()
    Id10186 = models.TextField()
    Id10187 = models.TextField()
    Id10188 = models.TextField()
    Id10189 = models.TextField()
    Id10190_units = models.TextField()
    Id10190_a = models.TextField()
    Id10190_b = models.TextField()
    Id10191 = models.TextField()
    Id10192 = models.TextField()
    Id10193 = models.TextField()
    Id10194 = models.TextField()
    Id10195 = models.TextField()
    id10196_unit = models.TextField()
    Id10196 = models.TextField()
    Id10197_a = models.TextField()
    Id10198 = models.TextField()
    Id10197 = models.TextField()
    Id10199 = models.TextField()
    Id10200 = models.TextField()
    Id10201_unit = models.TextField()
    Id10201_a = models.TextField()
    Id10202 = models.TextField()
    Id10201 = models.TextField()
    Id10203 = models.TextField()
    Id10204 = models.TextField()
    Id10205_unit = models.TextField()
    Id10205_a = models.TextField()
    Id10206 = models.TextField()
    Id10205 = models.TextField()
    Id10207 = models.TextField()
    Id10208 = models.TextField()
    Id10209_units = models.TextField()
    Id10209_a = models.TextField()
    Id10209_b = models.TextField()
    Id10209 = models.TextField()
    Id10210 = models.TextField()
    Id10211_units = models.TextField()
    Id10211_a = models.TextField()
    Id10211_b = models.TextField()
    Id10211 = models.TextField()
    Id10212 = models.TextField()
    Id10213_units = models.TextField()
    Id10213_a = models.TextField()
    Id10213_b = models.TextField()
    Id10213 = models.TextField()
    Id10214 = models.TextField()
    Id10215 = models.TextField()
    Id10216_units = models.TextField()
    Id10216_a = models.TextField()
    Id10216_b = models.TextField()
    Id10216 = models.TextField()
    Id10217 = models.TextField()
    Id10218 = models.TextField()
    Id10219 = models.TextField()
    Id10220 = models.TextField()
    Id10221 = models.TextField()
    Id10222 = models.TextField()
    Id10223 = models.TextField()
    Id10225 = models.TextField()
    Id10226 = models.TextField()
    Id10224 = models.TextField()
    Id10227 = models.TextField()
    Id10228 = models.TextField()
    Id10229 = models.TextField()
    Id10230 = models.TextField()
    Id10231 = models.TextField()
    Id10232_units = models.TextField()
    Id10232_a = models.TextField()
    Id10232_b = models.TextField()
    Id10232 = models.TextField()
    Id10233 = models.TextField()
    Id10234 = models.TextField()
    Id10235 = models.TextField()
    id10235_check = models.TextField()
    Id10236 = models.TextField()
    Id10237 = models.TextField()
    Id10238 = models.TextField()
    Id10239 = models.TextField()
    Id10240 = models.TextField()
    Id10241 = models.TextField()
    Id10242 = models.TextField()
    Id10243 = models.TextField()
    Id10244 = models.TextField()
    Id10245 = models.TextField()
    Id10246 = models.TextField()
    Id10247 = models.TextField()
    Id10248_units = models.TextField()
    Id10248_a = models.TextField()
    Id10248_b = models.TextField()
    Id10248 = models.TextField()
    Id10249 = models.TextField()
    Id10250_units = models.TextField()
    Id10250_a = models.TextField()
    Id10250_b = models.TextField()
    Id10250 = models.TextField()
    Id10251 = models.TextField()
    Id10252 = models.TextField()
    Id10253 = models.TextField()
    Id10254 = models.TextField()
    Id10255 = models.TextField()
    Id10256 = models.TextField()
    Id10257 = models.TextField()
    Id10258 = models.TextField()
    Id10259 = models.TextField()
    Id10260 = models.TextField()
    id10260_check = models.TextField()
    id10260_check2 = models.TextField()
    Id10261 = models.TextField()
    Id10262_units = models.TextField()
    Id10262_a = models.TextField()
    Id10262_b = models.TextField()
    Id10262 = models.TextField()
    Id10263 = models.TextField()
    Id10264 = models.TextField()
    Id10265 = models.TextField()
    Id10266_units = models.TextField()
    Id10266_a = models.TextField()
    Id10266_b = models.TextField()
    Id10266 = models.TextField()
    Id10267 = models.TextField()
    Id10268 = models.TextField()
    Id10269 = models.TextField()
    Id10270 = models.TextField()
    Id10271 = models.TextField()
    Id10272 = models.TextField()
    Id10273 = models.TextField()
    Id10274_a = models.TextField()
    Id10274_units = models.TextField()
    Id10274_b = models.TextField()
    Id10274_c = models.TextField()
    Id10274 = models.TextField()
    Id10275 = models.TextField()
    Id10276 = models.TextField()
    Id10277 = models.TextField()
    Id10278 = models.TextField()
    Id10279 = models.TextField()
    Id10281 = models.TextField()
    Id10282 = models.TextField()
    Id10283 = models.TextField()
    Id10284 = models.TextField()
    Id10285 = models.TextField()
    Id10286 = models.TextField()
    Id10287 = models.TextField()
    Id10288 = models.TextField()
    Id10289 = models.TextField()
    Id10290 = models.TextField()
    Id10294 = models.TextField()
    Id10295 = models.TextField()
    Id10296 = models.TextField()
    Id10297 = models.TextField()
    Id10298 = models.TextField()
    Id10301 = models.TextField()
    Id10299 = models.TextField()
    Id10302 = models.TextField()
    Id10303 = models.TextField()
    Id10300 = models.TextField()
    Id10304 = models.TextField()
    Id10305 = models.TextField()
    Id10306 = models.TextField()
    Id10307 = models.TextField()
    Id10308 = models.TextField()
    Id10309 = models.TextField()
    Id10310 = models.TextField()
    Id10310_check = models.TextField()
    Id10312 = models.TextField()
    Id10313 = models.TextField()
    Id10314 = models.TextField()
    Id10315_a = models.TextField()
    Id10315 = models.TextField()
    Id10316 = models.TextField()
    Id10317 = models.TextField()
    Id10318 = models.TextField()
    Id10319 = models.TextField()
    Id10320 = models.TextField()
    Id10321 = models.TextField()
    Id10322 = models.TextField()
    Id10323 = models.TextField()
    Id10324 = models.TextField()
    Id10325 = models.TextField()
    Id10326 = models.TextField()
    Id10327 = models.TextField()
    Id10328 = models.TextField()
    Id10329 = models.TextField()
    Id10330 = models.TextField()
    Id10331 = models.TextField()
    Id10332 = models.TextField()
    Id10333 = models.TextField()
    Id10334 = models.TextField()
    Id10335 = models.TextField()
    Id10336 = models.TextField()
    Id10337 = models.TextField()
    Id10338 = models.TextField()
    Id10339 = models.TextField()
    Id10342 = models.TextField()
    Id10343 = models.TextField()
    Id10344 = models.TextField()
    Id10347 = models.TextField()
    Id10340 = models.TextField()
    Id10352_units = models.TextField()
    Id10352_a = models.TextField()
    Id10352_b = models.TextField()
    Id10352 = models.TextField()
    Id10354 = models.TextField()
    Id10355 = models.TextField()
    Id10356 = models.TextField()
    Id10357 = models.TextField()
    Id10358_units = models.TextField()
    Id10358 = models.TextField()
    Id10359 = models.TextField()
    Id10359_a = models.TextField()
    Id10360 = models.TextField()
    Id10361 = models.TextField()
    Id10362 = models.TextField()
    Id10363 = models.TextField()
    Id10364 = models.TextField()
    Id10365 = models.TextField()
    id1036X_check = models.TextField()
    Id10366_unit = models.TextField()
    Id10366_a = models.TextField()
    Id10366_b = models.TextField()
    Id10366 = models.TextField()
    Id10367 = models.TextField()
    Id10368 = models.TextField()
    Id10369 = models.TextField()
    Id10370 = models.TextField()
    Id10371 = models.TextField()
    Id10372 = models.TextField()
    Id10373 = models.TextField()
    Id10394 = models.TextField()
    Id10376 = models.TextField()
    Id10377 = models.TextField()
    Id10379_unit = models.TextField()
    Id10379 = models.TextField()
    Id10380 = models.TextField()
    Id10382 = models.TextField()
    Id10383 = models.TextField()
    Id10384 = models.TextField()
    Id10385 = models.TextField()
    Id10387 = models.TextField()
    Id10388 = models.TextField()
    Id10389 = models.TextField()
    id10389_check = models.TextField()
    Id10391 = models.TextField()
    Id10392 = models.TextField()
    Id10393 = models.TextField()
    Id10395 = models.TextField()
    Id10396 = models.TextField()
    Id10397 = models.TextField()
    Id10398 = models.TextField()
    Id10399 = models.TextField()
    Id10400 = models.TextField()
    Id10401 = models.TextField()
    Id10402 = models.TextField()
    Id10403 = models.TextField()
    Id10404 = models.TextField()
    Id10405 = models.TextField()
    Id10406 = models.TextField()
    Id10411 = models.TextField()
    Id10412 = models.TextField()
    Id10413 = models.TextField()
    Id10414 = models.TextField()
    id10414_check = models.TextField()
    Id10415 = models.TextField()
    Id10416 = models.TextField()
    Id10418 = models.TextField()
    Id10419 = models.TextField()
    Id10420 = models.TextField()
    Id10421 = models.TextField()
    Id10422 = models.TextField()
    Id10423 = models.TextField()
    Id10424 = models.TextField()
    Id10425 = models.TextField()
    Id10426 = models.TextField()
    Id10427 = models.TextField()
    Id10428 = models.TextField()
    Id10429 = models.TextField()
    Id10430 = models.TextField()
    Id10431 = models.TextField()
    id10431_check = models.TextField()
    Id10432 = models.TextField()
    Id10433 = models.TextField()
    id10433_check = models.TextField()
    Id10434 = models.TextField()
    Id10435 = models.TextField()
    Id10436 = models.TextField()
    Id10437 = models.TextField()
    Id10438 = models.TextField()
    Id10439_check = models.TextField()
    Id10439 = models.TextField()
    Id10440_check = models.TextField()
    Id10440 = models.TextField()
    Id10441_check = models.TextField()
    Id10441 = models.TextField()
    Id10442 = models.TextField()
    Id10443 = models.TextField()
    Id10444 = models.TextField()
    Id10445 = models.TextField()
    Id10446 = models.TextField()
    Id10450 = models.TextField()
    Id10451 = models.TextField()
    Id10452 = models.TextField()
    Id10453 = models.TextField()
    Id10454 = models.TextField()
    Id10455 = models.TextField()
    Id10456 = models.TextField()
    Id10457 = models.TextField()
    Id10458 = models.TextField()
    Id10459 = models.TextField()
    Id10462 = models.TextField()
    Id10463 = models.TextField()
    Id10464 = models.TextField()
    Id10465 = models.TextField()
    Id10466 = models.TextField()
    Id10467 = models.TextField()
    Id10468 = models.TextField()
    Id10469 = models.TextField()
    Id10470 = models.TextField()
    Id10471 = models.TextField()
    Id10472 = models.TextField()
    Id10473 = models.TextField()
    Id10481 = models.TextField()
    geopoint = models.TextField()
    comment = models.TextField()
    # Track the history of changes to each verbal autopsy
    history = HistoricalRecords()
    # Automatically set timestamps
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)

class CauseOfDeath(models.Model):
    # One VerbalAutopsy can have multiple causes of death (through different algorithms)
    verbalautopsy = models.ForeignKey(VerbalAutopsy, related_name='causes', on_delete=models.CASCADE)
    # Track the cause and the algorithm that provided the cause
    cause = models.TextField()
    # TODO: do we want the algorithm as a string or by referring to an algorithm table?
    algorithm = models.TextField()
    # Store the settings used for this particular coding run
    # NOTE: by using JSONField we tie ourselves to postgres
    settings = JSONField()
    # Track the history of changes to each verbal autopsy cause of death coding
    # TODO: confirm that we need a history of this
    history = HistoricalRecords()
    # Automatically set timestamps
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.cause

class CauseCodingIssue(models.Model):
    # One VerbalAutopsy can have multiple coding issues
    verbalautopsy = models.ForeignKey(VerbalAutopsy, related_name='coding_issues', on_delete=models.CASCADE)
    text = models.TextField()
    SEVERITY_OPTIONS = ['error', 'warning']
    severity = models.CharField(max_length=7, choices=[(option, option) for option in SEVERITY_OPTIONS])
    # We track which algorithm and the settings for that algorithm
    # NOTE: this is a denormalized approach for convenience, which should still scale reasonably
    algorithm = models.TextField()
    # NOTE: by using JSONField we tie ourselves to postgres
    settings = JSONField()
    # Automatically set timestamps
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.text
